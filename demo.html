<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QMemory Library - Interactive Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #4a5568;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .subtitle {
        color: #718096;
        font-size: 1.1em;
        margin-bottom: 20px;
      }

      .status-indicator {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        margin: 10px 0;
        display: inline-block;
      }

      #requestStatus {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin: 5px 0;
        display: inline-block;
      }

      .status-ready {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-processing {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status-connected {
        background: #48bb78;
        color: white;
      }

      .status-disconnected {
        background: #f56565;
        color: white;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .tab {
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #4a5568;
      }

      .tab:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
      }

      .tab.active {
        background: #4299e1;
        color: white;
      }

      .tab-content {
        display: none;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .tab-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #4a5568;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #4299e1;
      }

      button {
        background: #4299e1;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      button:hover {
        background: #3182ce;
        transform: translateY(-2px);
      }

      button.secondary {
        background: #718096;
      }

      button.secondary:hover {
        background: #4a5568;
      }

      button.danger {
        background: #f56565;
      }

      button.danger:hover {
        background: #e53e3e;
      }

      .response {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }

      .response.error {
        background: #fed7d7;
        border-color: #f56565;
      }

      .response.success {
        background: #c6f6d5;
        border-color: #48bb78;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
      }

      .card h3 {
        margin-bottom: 15px;
        color: #4a5568;
      }

      .user-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .user-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info h4 {
        margin-bottom: 5px;
        color: #2d3748;
      }

      .user-info p {
        color: #718096;
        font-size: 0.9em;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
      }

      .pagination button {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      .pagination span {
        color: #4a5568;
        font-weight: 600;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4299e1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #4299e1, #3182ce);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .alert.info {
        background: #bee3f8;
        color: #2c5282;
        border: 1px solid #90cdf4;
      }

      .alert.warning {
        background: #feebc8;
        color: #7c2d12;
        border: 1px solid #fbd38d;
      }

      .alert.error {
        background: #fed7d7;
        color: #742a2a;
        border: 1px solid #fc8181;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        header {
          padding: 20px;
        }

        h1 {
          font-size: 2em;
        }

        .tabs {
          justify-content: center;
        }

        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script src="/public/api-service.js"></script>
    <script src="/public/direct-api-client.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üöÄ QMemory Library Demo</h1>
        <p class="subtitle">
          Production-ready Node.js utility library - Interactive Testing Interface
        </p>
        <div id="serverStatus" class="status-indicator status-disconnected">
          üî¥ Server Status: Disconnected
        </div>
        <div id="requestStatus" class="status-ready">‚úÖ Ready</div>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalRequests">0</div>
            <div class="stat-label">API Requests</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="successRate">0%</div>
            <div class="stat-label">Success Rate</div>
          </div>
        </div>
      </header>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('overview', event)">üìä Overview</button>
        <button class="tab" onclick="switchTab('users', event)">üë• User Management</button>
        <button class="tab" onclick="switchTab('utils', event)">üõ†Ô∏è Utilities</button>
        <button class="tab" onclick="switchTab('storage', event)">üíæ Storage</button>
        <button class="tab" onclick="switchTab('http', event)">üåê HTTP Utils</button>
        <button class="tab" onclick="switchTab('docs', event)">üìö Documentation</button>
      </div>

      <!-- Overview Tab -->
      <div id="overview" class="tab-content active">
        <h2>üéØ Library Overview</h2>
        <div class="alert info">
          <strong>Welcome!</strong> This interactive demo showcases all QMemory library
          functionality. Start by checking server connectivity below.
        </div>

        <div class="grid">
          <div class="card">
            <h3>üîó Server Connection</h3>
            <p>Test connectivity to the demo server:</p>
            <button onclick="checkServerHealth()">Check Health</button>
            <button onclick="getServerInfo()" class="secondary">Server Info</button>
            <div id="healthResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>üìà Quick Stats</h3>
            <p>Real-time library statistics:</p>
            <button onclick="refreshStats()">Refresh Stats</button>
            <div id="statsResponse" class="response hidden"></div>
          </div>
        </div>

        <div class="card">
          <h3>üöÄ Features Available</h3>
          <ul>
            <li><strong>Document Operations:</strong> User-owned CRUD with MongoDB</li>
            <li><strong>HTTP Utilities:</strong> Standardized Express.js responses</li>
            <li><strong>In-Memory Storage:</strong> Development-friendly user storage</li>
            <li><strong>Basic Utilities:</strong> String, math, and validation helpers</li>
            <li><strong>Performance Monitoring:</strong> Built-in metrics and health checks</li>
            <li><strong>Error Handling:</strong> Comprehensive error patterns</li>
          </ul>
        </div>
      </div>

      <!-- User Management Tab -->
      <div id="users" class="tab-content">
        <h2>üë• User Management</h2>

        <div class="grid">
          <div class="card">
            <h3>Create User</h3>
            <form id="createUserForm">
              <div class="form-group">
                <label for="username">Username *</label>
                <input
                  type="text"
                  id="username"
                  name="username"
                  required
                  placeholder="Enter username"
                />
              </div>
              <div class="form-group">
                <label for="displayName">Display Name</label>
                <input
                  type="text"
                  id="displayName"
                  name="displayName"
                  placeholder="Enter display name"
                />
              </div>
              <button type="submit">Create User</button>
              <button type="button" onclick="clearCreateForm()" class="secondary">Clear</button>
            </form>
            <div id="createUserResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>Find User</h3>
            <div class="form-group">
              <label for="userId">User ID</label>
              <input type="number" id="userId" placeholder="Enter user ID" />
            </div>
            <button onclick="findUser()">Find User</button>
            <button onclick="findUserByUsername()" class="secondary">Find by Username</button>
            <div id="findUserResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>Update User</h3>
            <form id="updateUserForm">
              <div class="form-group">
                <label for="updateUserId">User ID *</label>
                <input
                  type="number"
                  id="updateUserId"
                  name="updateUserId"
                  required
                  placeholder="Enter user ID"
                />
              </div>
              <div class="form-group">
                <label for="updateUsername">Username</label>
                <input
                  type="text"
                  id="updateUsername"
                  name="updateUsername"
                  placeholder="Enter new username"
                />
              </div>
              <div class="form-group">
                <label for="updateDisplayName">Display Name</label>
                <input
                  type="text"
                  id="updateDisplayName"
                  name="updateDisplayName"
                  placeholder="Enter new display name"
                />
              </div>
              <div class="form-group">
                <label for="updateGithubId">GitHub ID</label>
                <input
                  type="text"
                  id="updateGithubId"
                  name="updateGithubId"
                  placeholder="Enter GitHub ID"
                />
              </div>
              <div class="form-group">
                <label for="updateAvatar">Avatar URL</label>
                <input
                  type="text"
                  id="updateAvatar"
                  name="updateAvatar"
                  placeholder="Enter avatar URL"
                />
              </div>
              <button type="submit">Update User</button>
              <button type="button" onclick="clearUpdateForm()" class="secondary">Clear</button>
            </form>
            <div id="updateUserResponse" class="response hidden"></div>
          </div>
        </div>

        <div class="card">
          <h3>User List with Pagination</h3>
          <div class="grid">
            <div>
              <label for="page">Page:</label>
              <input type="number" id="page" value="1" min="1" style="width: 80px" />
            </div>
            <div>
              <label for="limit">Limit:</label>
              <select id="limit">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
          <button onclick="loadUsers()">Load Users</button>
          <button onclick="loadAllUsers()" class="secondary">Load All Users</button>
          <button onclick="clearAllUsers()" class="danger">Clear All Users</button>

          <div id="userList" class="user-list hidden"></div>
          <div id="userPagination" class="pagination hidden"></div>
          <div id="loadUsersResponse" class="response hidden"></div>
        </div>
      </div>

      <!-- Utilities Tab -->
      <div id="utils" class="tab-content">
        <h2>üõ†Ô∏è Basic Utilities</h2>

        <div class="grid">
          <div class="card">
            <h3>Greeting Utility</h3>
            <div class="form-group">
              <label for="greetName">Name:</label>
              <input type="text" id="greetName" placeholder="Enter name" />
            </div>
            <button onclick="testGreet()">Test Greet</button>
            <div id="greetResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>Math Utilities</h3>
            <div class="form-group">
              <label for="addA">Number A:</label>
              <input type="number" id="addA" placeholder="First number" />
            </div>
            <div class="form-group">
              <label for="addB">Number B:</label>
              <input type="number" id="addB" placeholder="Second number" />
            </div>
            <button onclick="testAdd()">Test Addition</button>
            <div id="addResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>Even/Odd Check</h3>
            <div class="form-group">
              <label for="evenNum">Number:</label>
              <input type="number" id="evenNum" placeholder="Enter integer" />
            </div>
            <button onclick="testEven()">Test Even</button>
            <div id="evenResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>Deduplication</h3>
            <div class="form-group">
              <label for="dedupeInput">Array (comma-separated):</label>
              <input type="text" id="dedupeInput" placeholder="apple, banana, apple, orange" />
            </div>
            <button onclick="testDedupe()">Test Dedupe</button>
            <div id="dedupeResponse" class="response hidden"></div>
          </div>
        </div>
      </div>

      <!-- Storage Tab -->
      <div id="storage" class="tab-content">
        <h2>üíæ Storage Operations</h2>

        <div class="alert info">
          <strong>Note:</strong> The demo uses in-memory storage. Data is lost when the server
          restarts.
        </div>

        <div class="grid">
          <div class="card">
            <h3>Storage Statistics</h3>
            <button onclick="getStorageStats()">Get Storage Stats</button>
            <button onclick="testStorageCapacity()" class="secondary">Test Capacity</button>
            <div id="storageStatsResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>Batch Operations</h3>
            <div class="form-group">
              <label for="batchCount">Number of Users:</label>
              <input type="number" id="batchCount" value="5" min="1" max="20" />
            </div>
            <button onclick="createBatchUsers()">Create Batch Users</button>
            <button onclick="testBatchDelete()" class="secondary">Test Batch Delete</button>
            <div id="batchResponse" class="response hidden"></div>
          </div>
        </div>

        <div class="card">
          <h3>Storage Performance Test</h3>
          <p>Test storage performance with multiple operations:</p>
          <button onclick="runPerformanceTest()">Run Performance Test</button>
          <button onclick="stressTestStorage()" class="secondary">Stress Test</button>
          <div id="performanceResponse" class="response hidden"></div>
        </div>
      </div>

      <!-- HTTP Utils Tab -->
      <div id="http" class="tab-content">
        <h2>üåê HTTP Utilities</h2>

        <div class="grid">
          <div class="card">
            <h3>Error Response Testing</h3>
            <button onclick="testNotFound()">Test 404 Not Found</button>
            <button onclick="testConflict()" class="secondary">Test 409 Conflict</button>
            <button onclick="testServerError()" class="danger">Test 500 Server Error</button>
            <button onclick="testServiceUnavailable()" class="secondary">
              Test 503 Service Unavailable
            </button>
            <div id="httpErrorResponse" class="response hidden"></div>
          </div>

          <div class="card">
            <h3>Validation Testing</h3>
            <div class="form-group">
              <label for="validationData">Test Data:</label>
              <input type="text" id="validationData" placeholder="Enter test data" />
            </div>
            <button onclick="testValidationError()">Test Validation Error</button>
            <button onclick="testAuthError()" class="secondary">Test Auth Error</button>
            <div id="httpValidationResponse" class="response hidden"></div>
          </div>
        </div>

        <div class="card">
          <h3>Request/Response Analysis</h3>
          <p>Analyze HTTP request patterns and responses:</p>
          <button onclick="analyzeRequests()">Analyze Request Patterns</button>
          <button onclick="testResponseFormat()" class="secondary">Test Response Format</button>
          <div id="httpAnalysisResponse" class="response hidden"></div>
        </div>
      </div>

      <!-- Documentation Tab -->
      <div id="docs" class="tab-content">
        <h2>üìö Documentation & Examples</h2>

        <div class="card">
          <h3>API Endpoints</h3>
          <div class="grid">
            <div>
              <h4>Core Endpoints</h4>
              <ul>
                <li><code>GET /health</code> - Service health check</li>
                <li><code>GET /</code> - API information</li>
                <li><code>GET /users</code> - List users (paginated)</li>
                <li><code>POST /users</code> - Create user</li>
                <li><code>GET /users/:id</code> - Get user by ID</li>
                <li><code>PUT /users/:id</code> - Update user</li>
                <li><code>DELETE /users/:id</code> - Delete user</li>
                <li><code>GET /users/by-username/:username</code> - Get user by username</li>
                <li><code>POST /users/clear</code> - Clear all users</li>
              </ul>
            </div>
            <div>
              <h4>Response Format</h4>
              <pre>
{
  "message": "Success message",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "data": { ... }
}</pre
              >
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Library Features</h3>
          <div class="grid">
            <div>
              <h4>Document Operations</h4>
              <ul>
                <li>User-owned document CRUD</li>
                <li>Automatic ownership enforcement</li>
                <li>Uniqueness validation</li>
                <li>Bulk operations support</li>
              </ul>
            </div>
            <div>
              <h4>HTTP Utilities</h4>
              <ul>
                <li>Standardized error responses</li>
                <li>Request ID generation</li>
                <li>Response sanitization</li>
                <li>Timestamp handling</li>
              </ul>
            </div>
            <div>
              <h4>Storage Options</h4>
              <ul>
                <li>In-memory storage (development)</li>
                <li>MongoDB integration (production)</li>
                <li>Connection pooling</li>
                <li>Health monitoring</li>
              </ul>
            </div>
            <div>
              <h4>Utilities</h4>
              <ul>
                <li>String manipulation</li>
                <li>Math operations</li>
                <li>Array deduplication</li>
                <li>Input validation</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Usage Examples</h3>
          <div class="grid">
            <div>
              <h4>Basic User Creation</h4>
              <pre>
const response = await fetch('/users', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    username: 'johndoe',
    displayName: 'John Doe'
  })
});</pre
              >
            </div>
            <div>
              <h4>Paginated User Listing</h4>
              <pre>
const response = await fetch('/users?page=1&limit=10');
const data = await response.json();
console.log(data.data.users); // User array (nested in data.data)
console.log(data.data.pagination); // Pagination info</pre
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      const API_BASE = window.location.origin;
      let requestCount = 0;
      let successCount = 0;
      let currentPage = 1;
      let currentLimit = 10;

      // Import API service
      // Note: In a real project, you'd use proper module imports
      // For demo purposes, we'll inline the API service functionality

      // Initialize
      document.addEventListener('DOMContentLoaded', function () {
        checkServerHealth();
        setupEventListeners();
      });

      // Setup event listeners
      function setupEventListeners() {
        document.getElementById('createUserForm').addEventListener('submit', function (e) {
          e.preventDefault();
          createUser();
        });
        document.getElementById('updateUserForm').addEventListener('submit', function (e) {
          e.preventDefault();
          updateUser();
        });
      }

      // Tab switching
      function switchTab(tabName, event) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });

        // Remove active class from all tab buttons
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName).classList.add('active');

        // Add active class to clicked tab button
        if (event && event.target) {
          event.target.classList.add('active');
        }
      }

      // Server connectivity
      async function checkServerHealth() {
        try {
          const response = await fetch(`${API_BASE}/health`);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          updateServerStatus(true);
          showResponse('healthResponse', data, 'success');

          // Update stats
          if (data && data.userCount !== undefined) {
            document.getElementById('totalUsers').textContent = data.userCount;
          }
        } catch (error) {
          updateServerStatus(false);
          showResponse('healthResponse', { error: error.message || 'Unknown error' }, 'error');
        }
      }

      async function getServerInfo() {
        try {
          const data = await apiRequest('/');
          showResponse('healthResponse', data, 'success');
        } catch (error) {
          showResponse('healthResponse', { error: error.message }, 'error');
        }
      }

      function updateServerStatus(connected) {
        const statusEl = document.getElementById('serverStatus');
        if (connected) {
          statusEl.className = 'status-indicator status-connected';
          statusEl.innerHTML = 'üü¢ Server Status: Connected';
        } else {
          statusEl.className = 'status-indicator status-disconnected';
          statusEl.innerHTML = 'üî¥ Server Status: Disconnected';
        }
      }

      // User Management
      async function createUser() {
        const username = document.getElementById('username').value;
        const displayName = document.getElementById('displayName').value;

        if (!username || !username.trim()) {
          showResponse('createUserResponse', { error: 'Username is required' }, 'error');
          return;
        }

        try {
          const data = await apiRequest('/users', {
            method: 'POST',
            body: JSON.stringify({ username: username.trim(), displayName: displayName || null })
          });
          showResponse('createUserResponse', data, 'success');

          clearCreateForm();
          refreshStats();
        } catch (error) {
          showResponse('createUserResponse', { error: error.message || 'Network error' }, 'error');
        }
      }



      function clearCreateForm() {
        document.getElementById('username').value = '';
        document.getElementById('displayName').value = '';
      }

      function clearUpdateForm() {
        document.getElementById('updateUserId').value = '';
        document.getElementById('updateUsername').value = '';
        document.getElementById('updateDisplayName').value = '';
        document.getElementById('updateGithubId').value = '';
        document.getElementById('updateAvatar').value = '';
      }

      async function updateUser() {
        const userId = parseInt(document.getElementById('updateUserId').value);
        const username = document.getElementById('updateUsername').value;
        const displayName = document.getElementById('updateDisplayName').value;
        const githubId = document.getElementById('updateGithubId').value;
        const avatar = document.getElementById('updateAvatar').value;

        if (!userId || isNaN(userId) || userId <= 0) {
          showResponse('updateUserResponse', { error: 'Valid User ID is required' }, 'error');
          return;
        }

        const updateData = {};
        if (username) updateData.username = username.trim();
        if (displayName) updateData.displayName = displayName.trim();
        if (githubId) updateData.githubId = githubId.trim();
        if (avatar) updateData.avatar = avatar.trim();

        if (Object.keys(updateData).length === 0) {
          showResponse('updateUserResponse', { error: 'At least one field must be provided for update' }, 'error');
          return;
        }

        try {
          const data = await apiRequest(`/users/${userId}`, {
            method: 'PUT',
            body: JSON.stringify(updateData)
          });
          showResponse('updateUserResponse', data, 'success');
          clearUpdateForm();
          refreshStats();
        } catch (error) {
          showResponse('updateUserResponse', { error: error.message || 'Network error' }, 'error');
        }
      }

      async function findUser() {
        const userId = document.getElementById('userId').value;

        if (!userId || isNaN(userId) || userId <= 0) {
          showResponse('findUserResponse', { error: 'Valid User ID is required' }, 'error');
          return;
        }

        try {
          const data = await apiRequest(`/users/${parseInt(userId)}`);
          showResponse('findUserResponse', data, 'success');
        } catch (error) {
          showResponse('findUserResponse', { error: error.message || 'Network error' }, 'error');
        }
      }

      async function findUserByUsername() {
        const username = prompt('Enter username to search:');
        if (!username) return;

        try {
          // Use the dedicated username endpoint instead of client-side filtering
          const data = await apiRequest(`/users/by-username/${encodeURIComponent(username)}`);
          showResponse('findUserResponse', data, 'success');
        } catch (error) {
          showResponse('findUserResponse', { error: error.message }, 'error');
        }
      }

      async function loadUsers() {
        const page = parseInt(document.getElementById('page').value) || 1;
        const limit = parseInt(document.getElementById('limit').value) || 10;

        if (page < 1 || limit < 1) {
          showResponse('loadUsersResponse', { error: 'Page and limit must be positive numbers' }, 'error');
          return;
        }

        try {
          const data = await apiRequest(`/users?page=${page}&limit=${limit}`);

          if (data && data.data) {
            displayUserList(data.data, data.pagination);
            showResponse('loadUsersResponse', data, 'success');
          } else {
            showResponse('loadUsersResponse', { error: 'Invalid response format' }, 'error');
          }
        } catch (error) {
          showResponse('loadUsersResponse', { error: error.message || 'Network error' }, 'error');
        }
      }

      async function loadAllUsers() {
        try {
          const data = await apiRequest('/users?page=1&limit=1000');

          if (data.data) {
            displayUserList(data.data, data.pagination);
            showResponse('loadUsersResponse', data, 'success');
          } else {
            showResponse('loadUsersResponse', data, 'error');
          }
        } catch (error) {
          showResponse('loadUsersResponse', { error: error.message }, 'error');
        }
      }

      async function clearAllUsers() {
        if (!confirm('Are you sure you want to delete all users? This action cannot be undone.')) {
          return;
        }

        try {
          const data = await apiRequest('/users/clear', {
            method: 'POST'
          });
          showResponse('loadUsersResponse', data, 'success');

          document.getElementById('userList').innerHTML = '';
          document.getElementById('userList').classList.add('hidden');
          refreshStats();
        } catch (error) {
          showResponse('loadUsersResponse', { error: error.message }, 'error');
        }
      }

      function displayUserList(users, pagination) {
        const listEl = document.getElementById('userList');
        const paginationEl = document.getElementById('userPagination');

        if (users.length === 0) {
          listEl.innerHTML = '<p>No users found.</p>';
          listEl.classList.remove('hidden');
          paginationEl.classList.add('hidden');
          return;
        }

        listEl.innerHTML = users
          .map(
            user => `
                <div class="user-item">
                    <div class="user-info">
                        <h4>${user.username} (ID: ${user.id})</h4>
                        <p>${user.displayName || 'No display name'}</p>
                    </div>
                    <div>
                        <button onclick="deleteUser(${user.id})" class="danger">Delete</button>
                    </div>
                </div>
            `
          )
          .join('');

        listEl.classList.remove('hidden');

        if (pagination) {
          paginationEl.innerHTML = `
                    <button onclick="changePage(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>Previous</button>
                    <span>Page ${pagination.page} of ${pagination.totalPages}</span>
                    <button onclick="changePage(${pagination.page + 1})" ${pagination.page >= pagination.totalPages ? 'disabled' : ''}>Next</button>
                `;
          paginationEl.classList.remove('hidden');
        }
      }

      function changePage(page) {
        if (page < 1) return;
        document.getElementById('page').value = page;
        loadUsers();
      }

      async function deleteUser(userId) {
        if (!userId || isNaN(userId) || userId <= 0) {
          showResponse('loadUsersResponse', { error: 'Valid User ID is required' }, 'error');
          return;
        }

        if (!confirm('Are you sure you want to delete this user?')) return;

        try {
          await apiRequest(`/users/${userId}`, {
            method: 'DELETE'
          });

          // Refresh current page
          loadUsers();
          refreshStats();
        } catch (error) {
          showResponse('loadUsersResponse', { error: error.error?.message || error.message || 'Network error during delete' }, 'error');
        }
      }

      // Utilities testing
      async function testGreet() {
        const name = document.getElementById('greetName').value || 'World';
        showResponse('greetResponse', { greeting: `Hello, ${name}!` }, 'success');
      }

      async function testAdd() {
        const a = parseFloat(document.getElementById('addA').value);
        const b = parseFloat(document.getElementById('addB').value);

        if (isNaN(a) || isNaN(b) || !isFinite(a) || !isFinite(b)) {
          showResponse('addResponse', { error: 'Please enter valid finite numbers' }, 'error');
          return;
        }

        const sum = a + b;
        showResponse('addResponse', { result: sum, operation: `${a} + ${b} = ${sum}` }, 'success');
      }

      async function testEven() {
        const num = parseInt(document.getElementById('evenNum').value);

        if (isNaN(num) || !isFinite(num)) {
          showResponse('evenResponse', { error: 'Please enter a valid integer' }, 'error');
          return;
        }

        const isEvenResult = num % 2 === 0;
        showResponse('evenResponse', { number: num, isEven: isEvenResult, message: `${num} is ${isEvenResult ? 'even' : 'odd'}` }, 'success');
      }

      async function testDedupe() {
        const input = document.getElementById('dedupeInput').value;
        if (!input) {
          showResponse('dedupeResponse', { error: 'Please enter comma-separated values' }, 'error');
          return;
        }

        const items = input.split(',').map(item => item.trim());
        const deduped = [...new Set(items)];

        showResponse(
          'dedupeResponse',
          {
            original: items,
            deduped: deduped,
            removed: items.length - deduped.length,
          },
          'success'
        );
      }

      // Storage operations
      async function getStorageStats() {
        try {
          const data = await apiRequest('/health');

          if (data.data) {
            const stats = {
              userCount: data.data.userCount,
              memoryUsage: data.data.memory,
              uptime: data.data.uptime,
            };
            showResponse('storageStatsResponse', stats, 'success');
          } else {
            showResponse('storageStatsResponse', data, 'success');
          }
        } catch (error) {
          showResponse('storageStatsResponse', { error: error.message }, 'error');
        }
      }

      async function testStorageCapacity() {
        const batchSize = 10;
        const results = [];

        for (let i = 0; i < batchSize; i++) {
          try {
            await apiRequest('/users', {
              method: 'POST',
              body: JSON.stringify({
                username: `testuser_${Date.now()}_${i}`,
                displayName: `Test User ${i}`,
              }),
            });

            results.push({
              attempt: i + 1,
              success: true,
              status: 200,
            });
          } catch (error) {
            results.push({
              attempt: i + 1,
              success: false,
              error: error.message,
            });
          }
        }

        showResponse(
          'storageStatsResponse',
          {
            test: 'Storage Capacity Test',
            results: results,
            successful: results.filter(r => r.success).length,
            failed: results.filter(r => !r.success).length,
          },
          'success'
        );
      }

      async function createBatchUsers() {
        const count = parseInt(document.getElementById('batchCount').value);
        const results = [];

        for (let i = 0; i < count; i++) {
          try {
            await apiRequest('/users', {
              method: 'POST',
              body: JSON.stringify({
                username: `batch_${Date.now()}_${i}`,
                displayName: `Batch User ${i + 1}`,
              }),
            });

            results.push({ user: i + 1, status: 'created' });
          } catch (error) {
            results.push({ user: i + 1, status: 'error', error: error.message });
          }
        }

        showResponse(
          'batchResponse',
          {
            operation: 'Batch User Creation',
            requested: count,
            successful: results.filter(r => r.status === 'created').length,
            failed: results.filter(r => r.status !== 'created').length,
            results: results,
          },
          'success'
        );

        refreshStats();
      }

      async function testBatchDelete() {
        // First create some users to delete
        await createBatchUsers();

        // Then get users and delete them
        try {
          const data = await apiRequest('/users?page=1&limit=10');

          if (data.data && data.data.users) {
            const deleteResults = [];

            for (const user of data.data.users) {
              try {
                await apiRequest(`/users/${user.id}`, {
                  method: 'DELETE'
                });

                deleteResults.push({
                  userId: user.id,
                  username: user.username,
                  deleted: true,
                });
              } catch (error) {
                deleteResults.push({
                  userId: user.id,
                  username: user.username,
                  deleted: false,
                  error: error.message,
                });
              }
            }

            showResponse(
              'batchResponse',
              {
                operation: 'Batch User Deletion',
                results: deleteResults,
                deleted: deleteResults.filter(r => r.deleted).length,
              },
              'success'
            );

            refreshStats();
          }
        } catch (error) {
          showResponse('batchResponse', { error: error.message }, 'error');
        }
      }
      }

      async function runPerformanceTest() {
        const iterations = 50;
        const results = {
          createUser: [],
          findUser: [],
          deleteUser: [],
        };

        showResponse('performanceResponse', { status: 'Running performance test...' }, 'success');

        // Test user creation performance
        const createStart = performance.now();
        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          try {
            await apiRequest('/users', {
              method: 'POST',
              body: JSON.stringify({
                username: `perf_${Date.now()}_${i}`,
                displayName: `Performance Test ${i}`,
              }),
            });
            results.createUser.push(performance.now() - start);
          } catch (error) {
            results.createUser.push(-1);
          }
        }
        const createEnd = performance.now();

        // Test user listing performance
        for (let i = 0; i < iterations; i++) {
          const start = performance.now();
          try {
            await apiRequest('/users');
            results.findUser.push(performance.now() - start);
          } catch (error) {
            results.findUser.push(-1);
          }
        }

        const stats = {
          test: 'Performance Test',
          iterations: iterations,
          createUser: {
            totalTime: createEnd - createStart,
            averageTime:
              results.createUser.filter(t => t > 0).reduce((a, b) => a + b, 0) /
              results.createUser.filter(t => t > 0).length,
            successful: results.createUser.filter(t => t > 0).length,
          },
          findUser: {
            averageTime:
              results.findUser.filter(t => t > 0).reduce((a, b) => a + b, 0) /
              results.findUser.filter(t => t > 0).length,
            successful: results.findUser.filter(t => t > 0).length,
          },
        };

        showResponse('performanceResponse', stats, 'success');
      }

      async function stressTestStorage() {
        const concurrentRequests = 20;
        const promises = [];

        showResponse('performanceResponse', { status: 'Running stress test...' }, 'success');

        const start = performance.now();

        for (let i = 0; i < concurrentRequests; i++) {
          promises.push(
            apiRequest('/users', {
              method: 'POST',
              body: JSON.stringify({
                username: `stress_${Date.now()}_${i}`,
                displayName: `Stress Test ${i}`,
              }),
            })
          );
        }

        try {
          const results = await Promise.allSettled(promises);
          const end = performance.now();
          const successful = results.filter(r => r.status === 'fulfilled').length;

          showResponse(
            'performanceResponse',
            {
              test: 'Stress Test',
              concurrentRequests: concurrentRequests,
              totalTime: end - start,
              successful: successful,
              failed: concurrentRequests - successful,
              successRate: `${((successful / concurrentRequests) * 100).toFixed(1)}%`,
            },
            'success'
          );

          refreshStats();
        } catch (error) {
          showResponse('performanceResponse', { error: error.message }, 'error');
        }
      }

      // HTTP Utilities testing
      async function testNotFound() {
        try {
          await apiRequest('/nonexistent-endpoint');
        } catch (error) {
          showResponse('httpErrorResponse', { error: error.message }, 'error');
        }
      }

      async function testConflict() {
        // Try to create a user with existing username
        try {
          await apiRequest('/users', {
            method: 'POST',
            body: JSON.stringify({ username: 'conflict-test', displayName: 'Test' }),
          });

          // Try again with same username
          try {
            await apiRequest('/users', {
              method: 'POST',
              body: JSON.stringify({ username: 'conflict-test', displayName: 'Test' }),
            });
            showResponse('httpErrorResponse', { status: 'success', data: 'No conflict detected' }, 'success');
          } catch (conflictError) {
            showResponse('httpErrorResponse', { error: conflictError.message }, 'error');
          }
        } catch (error) {
          showResponse('httpErrorResponse', { error: error.message }, 'error');
        }
      }

      async function testServerError() {
        // This would need a custom endpoint to trigger server error
        // For now, we'll show an example error response
        const exampleError = {
          error: {
            type: 'INTERNAL_ERROR',
            message: 'Internal server error',
            timestamp: new Date().toISOString(),
            requestId: 'req-' + Date.now(),
          },
        };
        showResponse(
          'httpErrorResponse',
          { example: exampleError, note: 'Example error response format' },
          'error'
        );
      }

      async function testServiceUnavailable() {
        // This would need a custom endpoint to trigger service unavailable
        const exampleError = {
          error: {
            type: 'SERVICE_UNAVAILABLE',
            message: 'Service temporarily unavailable',
            timestamp: new Date().toISOString(),
            requestId: 'req-' + Date.now(),
          },
        };
        showResponse(
          'httpErrorResponse',
          { example: exampleError, note: 'Example 503 response format' },
          'error'
        );
      }

      async function testValidationError() {
        const data = document.getElementById('validationData').value;
        if (!data) {
          showResponse('httpValidationResponse', { error: 'Please enter test data' }, 'error');
          return;
        }

        const exampleValidation = {
          error: {
            type: 'VALIDATION_ERROR',
            message: 'Validation failed',
            timestamp: new Date().toISOString(),
            requestId: 'req-' + Date.now(),
            details: { field: 'test', value: data, issue: 'Invalid format' },
          },
        };
        showResponse(
          'httpValidationResponse',
          { example: exampleValidation, testData: data },
          'error'
        );
      }

      async function testAuthError() {
        const exampleAuth = {
          error: {
            type: 'AUTHENTICATION_ERROR',
            message: 'Authentication required',
            timestamp: new Date().toISOString(),
            requestId: 'req-' + Date.now(),
          },
        };
        showResponse(
          'httpValidationResponse',
          { example: exampleAuth, note: 'Example 401 response format' },
          'error'
        );
      }

      async function analyzeRequests() {
        const analysis = {
          totalRequests: requestCount,
          successRate:
            requestCount > 0 ? ((successCount / requestCount) * 100).toFixed(1) + '%' : '0%',
          averageResponseTime: 'N/A (would need timing implementation)',
          endpoints: [
            { path: '/health', method: 'GET', description: 'Service health check' },
            { path: '/users', method: 'GET', description: 'List users (paginated)' },
            { path: '/users', method: 'POST', description: 'Create new user' },
            { path: '/users/:id', method: 'GET', description: 'Get user by ID' },
            { path: '/users/:id', method: 'DELETE', description: 'Delete user' },
          ],
        };
        showResponse('httpAnalysisResponse', analysis, 'success');
      }

      async function testResponseFormat() {
        const formats = {
          success: {
            message: 'Operation completed successfully',
            timestamp: new Date().toISOString(),
            data: { example: 'response data' },
          },
          error: {
            error: {
              type: 'ERROR_TYPE',
              message: 'Error description',
              timestamp: new Date().toISOString(),
              requestId: 'req-' + Date.now(),
            },
          },
          paginated: {
            data: [...Array(3)].map((_, i) => ({ id: i + 1, name: `Item ${i + 1}` })),
            pagination: {
              page: 1,
              limit: 10,
              total: 3,
              totalPages: 1,
            },
          },
        };
        showResponse('httpAnalysisResponse', formats, 'success');
      }

      // Stats and utilities
      function refreshStats() {
        checkServerHealth();
        updateRequestStats();
      }

      function updateRequestStats() {
        document.getElementById('totalRequests').textContent = requestCount;
        const rate = requestCount > 0 ? ((successCount / requestCount) * 100).toFixed(1) : '0';
        document.getElementById('successRate').textContent = rate + '%';
      }

      // API Service wrapper functions using our centralized service
      // Loading state management
      let isLoading = false;

      async function apiRequest(endpoint, options = {}) {
        if (isLoading) {
          console.warn('Request already in progress, ignoring duplicate call');
          return;
        }

        isLoading = true;
        updateLoadingStates(true);

        try {
          const response = await fetch(`${API_BASE}${endpoint}`, {
            headers: {
              'Content-Type': 'application/json',
              ...options.headers,
            },
            ...options,
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              errorData.error?.message ||
                errorData.message ||
                `HTTP ${response.status}: ${response.statusText}`
            );
          }

          return await response.json();
        } catch (error) {
          if (error instanceof Error) {
            throw error;
          }
          throw new Error('Network error occurred');
        } finally {
          isLoading = false;
          updateLoadingStates(false);
        }
      }

      function updateLoadingStates(loading) {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
          if (loading) {
            button.disabled = true;
            button.style.opacity = '0.6';
          } else {
            button.disabled = false;
            button.style.opacity = '1';
          }
        });

        // Update status indicator
        const statusEl = document.getElementById('requestStatus');
        if (statusEl) {
          statusEl.textContent = loading ? '‚è≥ Processing...' : '‚úÖ Ready';
          statusEl.className = loading ? 'status-processing' : 'status-ready';
        }
      }

          return await response.json();
        } catch (error) {
          if (error instanceof Error) {
            throw error;
          }
          throw new Error('Network error occurred');
        }
      }

      // Health check endpoints
      async function getHealth() {
        return apiRequest('/health');
      }

      async function getServerInfo() {
        return apiRequest('/');
      }

      // User management endpoints
      async function getUsers(page = 1, limit = 10) {
        return apiRequest(`/users?page=${page}&limit=${limit}`);
      }

      async function createUser(userData) {
        return apiRequest('/users', {
          method: 'POST',
          body: JSON.stringify(userData),
        });
      }

      async function getUserById(id) {
        return apiRequest(`/users/${id}`);
      }

      async function deleteUser(id) {
        return apiRequest(`/users/${id}`, {
          method: 'DELETE',
        });
      }

      async function clearAllUsers() {
        return apiRequest('/users/clear', {
          method: 'POST',
        });
      }

      function showResponse(elementId, data, type = 'info') {
        const element = document.getElementById(elementId);
        if (!element) {
          console.error(`Element with ID '${elementId}' not found`);
          return;
        }

        element.classList.remove('hidden', 'success', 'error');
        element.classList.add(type);
        element.textContent = JSON.stringify(data, null, 2);

        // Update request stats
        requestCount++;
        if (type === 'success') successCount++;
        updateRequestStats();
      }
    </script>
  </body>
</html>
